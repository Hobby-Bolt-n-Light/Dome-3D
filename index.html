<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Bilder's 3D Archive</title>

  <!-- A-Frame -->
  <!-- <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script> -->
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>

  <!-- Extrasï¼ˆç§»å‹•ãƒ»è£œåŠ©ç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

  <!-- Particle System -->
  <!--<script src="https://cdn.jsdelivr.net/npm/aframe-particle-system-component@1.1.4/dist/aframe-particle-system-component.min.js"></script>-->
  <!-- <script src="https://unpkg.com/aframe-particle-system-component@1.1.x/dist/aframe-particle-system-component.min.js"></script> -->
  <!-- <script src="aframe-particle-system-component.js"></script> -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&family=Outfit:wght@100..900&family=Zen+Kaku+Gothic+New&display=swap" rel="stylesheet">

  <style>
    body { margin: 0; overflow: hidden; }

    /* ç§»å‹•UI */
    .ui {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 10;
    }
    .ui button {
      padding: 12px 16px;
      font-size: 16px;
      opacity: 0.8;
    }
	  
	#intro {
	  position: fixed;
	  inset: 0;
	  background: rgba(0,0,0,0.7);
	  color: white;
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  text-align: center;
	  z-index: 20;
	  font-size: 5vmin;
	  font-family: "Zen Kaku Gothic New", sans-serif;
	  font-weight: bold;
      font-style: normal;
	}
	  
	#loading {
	  position: fixed;
	  inset: 0;
	  background: rgba(0,0.5,0.8,1);
	  color: white;
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  text-align: center;
	  z-index: 30;
	  font-size: 5vmin;
	  font-family: "Zen Kaku Gothic New", sans-serif;
	  font-weight: bold;
      font-style: normal;
	}
  </style>
</head>

<body>

<!-- UIãƒœã‚¿ãƒ³ -->
<div class="ui">
	<!--
	<button onclick="move(0, -0.3)">â†‘</button>
	<button onclick="move(-0.3, 0)">â†</button>
	<button onclick="move(0.3, 0)">â†’</button>
	<button onclick="move(0, 0.3)">â†“</button> 
	-->
	<button onmousedown="startMove(0, -1)" onmouseup="stopMove()">â†‘</button>
	<button onmousedown="startMove(-1, 0)" onmouseup="stopMove()">â†</button>
	<button onmousedown="startMove(1, 0)" onmouseup="stopMove()">â†’</button>
	<button onmousedown="startMove(0, 1)" onmouseup="stopMove()">â†“</button>
</div>



<!-- æ¡ˆå†…è¡¨ç¤º -->
<div id="loading">
	èª­ã¿è¾¼ã¿ä¸­â€¦
</div>
<div id="intro">
	<p>ç”»é¢ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦è¦–ç‚¹ã‚’ç§»å‹•ã§ãã¾ã™<br>
	 ãƒœã‚¿ãƒ³ã§ç§»å‹•ã§ãã¾ã™<br>
	 ã‚¿ãƒƒãƒ—ã—ã¦é–‹å§‹</p>
</div>

<a-scene id="scene">

  <!-- ã‚¢ã‚»ãƒƒãƒˆç®¡ç† -->
  <a-assets>
    <img id="sky" src="kloppenheim_06_puresky_small.jpg">
    <video id="movie_main3" src="assets/VR_Video_MainScreen_Anim_NoAudio.mp4" loop muted playsinline></video>
    <video id="movie" src="assets/TEST-1.mp4" loop muted playsinline></video>
    <a-asset-item id="dome" src="assets/BOD_v9_Env.glb"></a-asset-item>
    <a-asset-item id="screen" src="assets/BOD_v4_Screen.glb"></a-asset-item>
  </a-assets>

  <!-- ç©ºï¼ˆå›è»¢ã§å‘ãèª¿æ•´ï¼‰ -->
  <a-sky src="#sky" rotation="0 -90 0"></a-sky>

  <!-- ç©ºé–“ãƒ¢ãƒ‡ãƒ« -->
  <a-gltf-model
    src="#screen"
    position="0 0 0"
	rotation="0 -90 0"
    scale="2 2 2"
	material="src: #movie_main3">
  </a-gltf-model>
	
  <a-gltf-model
    src="#dome"
    position="0 0 0"
	rotation="0 -90 0"
    scale="2 2 2">
  </a-gltf-model>
	
  <!-- å‹•ç”»ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->
  <a-plane
    position="0 2 -4"
    width="3"
    height="1.7"
    material="src: #movie_main3">
  </a-plane>
	
  <a-plane
    position="0 0 0"
    width="0.5"
    height="0.281"
    material="src: #movie_main3">
  </a-plane>


  <!-- ã‚«ãƒ¡ãƒ©ãƒªã‚°ï¼ˆå††å½¢ç§»å‹•åˆ¶é™ï¼‰ -->
	<!--
  <a-entity id="rig" position="0 -1.3 0.5">
    <a-camera
      look-controls
      wasd-controls="acceleration: 10">
    </a-camera>
  </a-entity>-->

  <a-entity light="type: directional; color: #fff0e0; intensity: 2.0" position="-0.1 -0.2 1"></a-entity>
  <a-entity light="type: point; color: #fff0e0; intensity: 5.0" position="0 1 0"></a-entity>
	
	<a-entity id="rig"
		position="0 -1.3 0.5"
		relative-move="speed: 0.03; radius: 1.5">
			<a-camera look-controls></a-camera>
	</a-entity>
	

</a-scene>

<script>
	
	
	const scene = document.getElementById('scene');
	
	//***** æ¡ˆå†…è¡¨ç¤º *****
	const intro = document.getElementById('intro');
	intro.addEventListener('click', () => {
	  intro.style.display = 'none';
	  document.getElementById('movie').play();
	  document.getElementById('movie_main3').play();
	});
		
	//***** å‹•ç”»å†ç”Ÿ *****
	document.body.addEventListener('click', () => {
	  document.getElementById('movie').play();
	  document.getElementById('movie_main3').play();
	}, { once: true });
	
	
	scene.addEventListener('loaded', () => {
	  const model = document.querySelector('[gltf-model]');
	
	  model.addEventListener('model-loaded', () => {
	    const root = model.getObject3D('mesh');
	    const video = document.getElementById('movie_main3');
	
	    const videoTexture = new AFRAME.THREE.VideoTexture(video);
	    videoTexture.flipY = false;
	    videoTexture.colorSpace = AFRAME.THREE.SRGBColorSpace;
	    videoTexture.needsUpdate = true;
	
	    root.traverse(obj => {
		  console.log(obj.type, obj.name);
	      if (obj.type === 'Mesh' && obj.name === 'Screen') {
			obj.material.color.setRGB(1, 1, 1);
	        obj.material.map = videoTexture;
			//obj.material.emissive.set(1,1,1);
	        //obj.material.emissiveMap = videoTexture;
	        obj.material.needsUpdate = true;
	
	        console.log('ğŸ¥ Video texture applied to:', obj.name);
	      }
	    });
	  });

	  const loading = document.getElementById('loading');
	  loading.style.display = 'none';
	});

	
	//***** ç§»å‹•ç¯„å›²åˆ¶é™ *****
	/*
	  const rig = document.getElementById('rig');
	  const radius = 1.5; // å††å½¢ç§»å‹•ç¯„å›²
	
	  function move(dx, dz) {
	    const pos = rig.object3D.position;
	    pos.x += dx;
	    pos.z += dz;
	
	    // å††å½¢åˆ¶é™
	    const dist = Math.sqrt(pos.x * pos.x + pos.z * pos.z);
	    if (dist > radius) {
	      pos.x *= radius / dist;
	      pos.z *= radius / dist;
	    }
	  }
	*/
AFRAME.registerComponent('relative-move', {
  schema: {
    speed: { default: 0.005 },
    radius: { default: 1.5 }
  },

  init() {
    this.moveVec = { x: 0, z: 0 };
    this.moving = false;

    window.startMove = (x, z) => {
      this.moveVec.x = x;
      this.moveVec.z = z;
      this.moving = true;
    };

    window.stopMove = () => {
      this.moving = false;
    };
  },

  tick() {
    if (!this.moving) return;

    const rig = this.el;
    const camera = rig.querySelector('a-camera');

    const dir = new THREE.Vector3();
    camera.object3D.getWorldDirection(dir);
    dir.y = 0;
    dir.normalize();

    const right = new THREE.Vector3()
      .crossVectors(dir, new THREE.Vector3(0, 1, 0))
      .normalize();

    const pos = rig.object3D.position;

    pos.addScaledVector(dir, -this.moveVec.z * this.data.speed);
    pos.addScaledVector(right, this.moveVec.x * this.data.speed);

    // å††å½¢åˆ¶é™
    const d = Math.sqrt(pos.x * pos.x + pos.z * pos.z);
    if (d > this.data.radius) {
      pos.multiplyScalar(this.data.radius / d);
    }
  }
});
</script>

</body>
</html>
