<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<title>Bilder's 3D Archive</title>
	
	<!-- A-Frame -->
	<!-- <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script> -->
	<script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
	
	<!-- Extrasï¼ˆç§»å‹•ãƒ»è£œåŠ©ç”¨ï¼‰ -->
	<script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
	
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&family=Outfit:wght@100..900&family=Zen+Kaku+Gothic+New&display=swap" rel="stylesheet">
	
	<style>
		body { margin: 0; overflow: hidden; font-family: "Zen Kaku Gothic New", sans-serif; font-weight: bold;}
		
		/* ç§»å‹•UI */
		.ui {
		  position: fixed;
		  bottom: 20px;
		  left: 50%;
		  transform: translateX(-50%);
		  display: flex;
		  gap: 10px;
		  z-index: 10;
		}
		.ui button {
		  padding: 12px 16px;
		  font-size: 16px;
		  opacity: 0.8;
		}
		  
		#intro {
		  position: fixed;
		  inset: 0;
		  background: rgba(0,0,0,0.7);
		  color: white;
		  display: flex;
		  align-items: center;
		  justify-content: center;
		  text-align: center;
		  z-index: 20;
		  font-size: 5vmin;
		  font-family: "Zen Kaku Gothic New", sans-serif;
		  font-weight: bold;
		  font-style: normal;
		}
		  
		#loading {
		  position: fixed;
		  inset: 0;
		  background: rgba(0,0.5,0.8,1);
		  color: white;
		  display: flex;
		  align-items: center;
		  justify-content: center;
		  text-align: center;
		  z-index: 30;
		  font-size: 4vmin;
		  font-family: "Zen Kaku Gothic New", sans-serif;
		  font-weight: bold;
		  font-style: normal;
		}
	</style>
</head>

<body>

<!-- UIãƒœã‚¿ãƒ³ -->
<div class="ui">
	<button onmousedown="startMove(0, 1)" onmouseup="stopMove()" ontouchstart="startMove(0, 1)" ontouchend="stopMove()">â†‘</button>
	<button onmousedown="startMove(1, 0)" onmouseup="stopMove()" ontouchstart="startMove(1, 0)" ontouchend="stopMove()">â†</button>
	<button onmousedown="startMove(-1, 0)" onmouseup="stopMove()" ontouchstart="startMove(-1, 0)" ontouchend="stopMove()">â†’</button>
	<button onmousedown="startMove(0, -1)" onmouseup="stopMove()" ontouchstart="startMove(0, -1)" ontouchend="stopMove()">â†“</button>
</div>
<div id="panelInfo" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  color: white;
  display: none;
  z-index: 40;
  padding: 5vmin;
">
  <button onclick="closeInfo()" style="position:absolute;top:20px;left:20px;">
    â† æˆ»ã‚‹
  </button>
  <div id="panelText"></div>
</div>



<!-- æ¡ˆå†…è¡¨ç¤º -->
<div id="loading">
  èª­ã¿è¾¼ã¿ä¸­â€¦
</div>
<div id="intro">
  <p>å·¦å³ã«ã‚¹ãƒ¯ã‚¤ãƒ—ã—ã¦å‘ãå¤‰æ›´<br>
  ç”»é¢ä¸‹ã®ãƒœã‚¿ãƒ³ã§ç§»å‹•<br><br>
  ã‚¿ãƒƒãƒ—ã—ã¦é–‹å§‹</p>
</div>

<a-scene id="scene">

  <!-- ã‚¢ã‚»ãƒƒãƒˆç®¡ç† -->
  <a-assets>
    <img id="sky" src="kloppenheim_06_puresky_small.jpg">
    <video id="movie_main3" src="assets/VR_Video_MainScreen_Anim_NoAudio.mp4" loop muted playsinline></video>
    <video id="movie" src="assets/TEST-1.mp4" loop muted playsinline></video>
    <a-asset-item id="dome" src="assets/BOD_v9_Env.glb"></a-asset-item>
    <a-asset-item id="screen" src="assets/BOD_v4_Screen.glb"></a-asset-item>
    <a-asset-item id="panels" src="assets/BOD_v1_Panels.glb"></a-asset-item>

	<!-- ç”»åƒãƒ‡ãƒ¼ã‚¿ -->
	<img id="panel1-img" src="assets/panel1.jpg">
	<img id="panel2-img" src="assets/panel2.jpg">
	<img id="panel3-img" src="assets/panel3.jpg">
	<img id="panel4-img" src="assets/panel4.jpg">
	<img id="panel5-img" src="assets/panel5.jpg">
	<img id="panel6-img" src="assets/panel6.jpg">

  </a-assets>

  <!-- ç©ºï¼ˆå›è»¢ã§å‘ãèª¿æ•´ï¼‰ -->
  <a-sky src="#sky" rotation="0 -90 0"></a-sky>

  <!-- ç©ºé–“ãƒ¢ãƒ‡ãƒ« -->

  <!--
  <a-gltf-model
    src="#panels"
    position="0 0 0"
	rotation="0 -90 0"
    scale="2 2 2">
  </a-gltf-model>
	-->


  <a-gltf-model
    src="#screen"
    position="0 0 0"
	rotation="0 -90 0"
    scale="2 2 2"
	material="src: #movie_main3">
  </a-gltf-model>
	
	
  <a-gltf-model
    src="#dome"
    position="0 0 0"
	rotation="0 -90 0"
    scale="2 2 2">
  </a-gltf-model>
	
	
  <!-- å‹•ç”»ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->
  <a-plane
    position="1.5 0.5 0"
	rotation="0 90 0"
    width="0.5"
    height="0.281"
    material="src: #movie_main3">
	<material side="double"></material>
  </a-plane>

  <!--<a-octahedron position="0 0 0" color="blue" scale="0.1 0.1 0.1"></a-octahedron>-->


  <!-- ã‚«ãƒ¡ãƒ©ãƒªã‚°ï¼ˆå††å½¢ç§»å‹•åˆ¶é™ï¼‰ -->

  <a-entity light="type: directional; color: #fff0e0; intensity: 1.5" position="-0.1 -0.2 1"></a-entity>
  <a-entity light="type: point; color: #fff0e0; intensity: 5.0" position="0 1 0"></a-entity>
	
	<a-entity id="rig"
		position="0 -1.3 0.5"
		relative-move="speed: 0.03; radius: 1.5">
			<a-camera
			  look-controls
			  raycaster="objects: .clickable"
			  cursor="rayOrigin: entity"
			  near="0.05"
			  far="50">
			</a-camera>
	</a-entity>
	

</a-scene>

<script>
	
	const scene = document.getElementById('scene');
	
	//***** æ¡ˆå†…è¡¨ç¤º *****
	const intro = document.getElementById('intro');
	intro.addEventListener('click', () => {
	  	intro.style.display = 'none';
	  	document.getElementById('movie').play();
	  	document.getElementById('movie_main3').play();
	});
		
	//***** å‹•ç”»å†ç”Ÿ *****
	document.body.addEventListener('click', () => {
	  	console.log('Body clicked! : movie starts');
	  	document.getElementById('movie').play();
	  	document.getElementById('movie_main3').play();
	}, { once: true });

	
	//***** èª­ã¿è¾¼ã¿å®Œäº†å‡¦ç†ï¼ˆèª­ã¿è¾¼ã¿è¡¨ç¤ºçµ‚äº†ï¼‰ *****
	scene.addEventListener('loaded', () => {
		console.log('Data loaded');
		const loading = document.getElementById('loading');
		loading.style.display = 'none';
	});
	
	
	//***** å‹•ç”»è²¼ã‚Šä»˜ã‘ã€€ï¼‹ã€€ç”»åƒè²¼ã‚Šä»˜ã‘ *****
	const screenEl = document.querySelector('a-gltf-model[src="#screen"]');
	screenEl.addEventListener('model-loaded', () => {
		const root = screenEl.getObject3D('mesh');
		if (!root) return;
		const video = document.getElementById('movie_main3');
		
		const videoTexture = new AFRAME.THREE.VideoTexture(video);
		videoTexture.flipY = false;
		videoTexture.colorSpace = AFRAME.THREE.SRGBColorSpace;
		videoTexture.needsUpdate = true;
		
		root.traverse(obj => {
			console.log(obj.type, obj.name);
			if (obj.type === 'Mesh' && obj.name === 'Screen') {
				console.log('Screen Found');
				obj.material.color.setRGB(1, 1, 1);
				obj.material.map = videoTexture;
				//obj.material.emissive.set(1,1,1);
				//obj.material.emissiveMap = videoTexture;
				obj.material.needsUpdate = true;
				
				console.log('ğŸ¥ Video texture applied to:', obj.name);
			}
		});
	});
	
	
	const panelsEl = document.querySelector('a-gltf-model[src="#panels"]');
	panelsEl.addEventListener('model-loaded', () => {
		console.log('panels loaded');
		
		const panelsRoot = panelsEl.getObject3D('mesh');
		if (!panelsRoot) return;
		
		// â˜… â‘  Panel ã‚’ä¸€æ—¦é›†ã‚ã‚‹
		const panelMeshes = [];
		
		panelsRoot.traverse(obj => {
			console.log(obj.type, obj.name);
			if (obj.type === 'Mesh' && obj.name.startsWith('Panel')) {
				panelMeshes.push(obj);
			}
		});
		
		console.log('Collected panels:', panelMeshes.map(p => p.name));
		
		// â˜… â‘¡ traverse å¾Œã«å‡¦ç†
		panelMeshes.forEach(obj => {
		
			console.log('Process panel:', obj.name);
			
			// --- texture ---
			const img = document.getElementById(
				obj.name.toLowerCase() + '-img'
			);
			
			const tex = new THREE.Texture(img);
			tex.colorSpace = THREE.SRGBColorSpace;
			tex.needsUpdate = true;
			
			obj.material.map = tex;
			obj.material.transparent = true;
			obj.material.needsUpdate = true;
			
			// --- entity ---
			const panelEl = document.createElement('a-entity');
			//panelsEl.object3D.add(panelEl.object3D);
			panelsEl.appendChild(panelEl); // â† å¿…é ˆ
			
			// transform ç¶™æ‰¿
			panelEl.object3D.position.copy(obj.position);
			panelEl.object3D.quaternion.copy(obj.quaternion);
			panelEl.object3D.scale.copy(obj.scale);
			
			// Mesh ã‚’ç§»å‹•
			obj.parent.remove(obj);
			panelEl.object3D.add(obj);
			
			// Mesh ãƒªã‚»ãƒƒãƒˆ
			obj.position.set(0, 0, 0);
			obj.rotation.set(0, 0, 0);
			obj.scale.set(1, 1, 1);
			
			// ID ã¯ entity ã«æŒãŸã›ã‚‹
			panelEl.userData = { panelId: obj.name };
			
			// ã‚¯ãƒªãƒƒã‚¯ç”¨ Plane
			panelEl.setAttribute('geometry', {
			  primitive: 'plane',
			  width: 1.0,
			  height: 1.0
			});
			/*
			panelEl.setAttribute('material', {
			  opacity: 0.001,
			  transparent: true
			});*/
			panelEl.setAttribute('material', {
			  color: 'red',
			  opacity: 0.5,
			  side: 'double'
			});
			
			panelEl.object3D.position.z += 0.01;
			
			panelEl.classList.add('clickable');
			panelEl.setAttribute('float-y', '');
			panelEl.setAttribute('panel-interaction', '');

			
		});
	});


	/*
	scene.addEventListener('click', (evt) => {
	  const intersected = evt.detail.intersectedEl;
	  if (!intersected) return;
	
	  const mesh = intersected.getObject3D('mesh');
	  if (!mesh) return;
	
	  mesh.traverse(obj => {
	    if (obj.userData.panelId) {
	      document.getElementById('panelText').innerHTML =
	        panelTexts[obj.userData.panelId];
	      document.getElementById('panelInfo').style.display = 'block';
	    }
	  });
	});*/


	
	//***** ç§»å‹•ç¯„å›²åˆ¶é™ *****
	/*
	  const rig = document.getElementById('rig');
	  const radius = 1.5; // å††å½¢ç§»å‹•ç¯„å›²
	
	  function move(dx, dz) {
	    const pos = rig.object3D.position;
	    pos.x += dx;
	    pos.z += dz;
	
	    // å††å½¢åˆ¶é™
	    const dist = Math.sqrt(pos.x * pos.x + pos.z * pos.z);
	    if (dist > radius) {
	      pos.x *= radius / dist;
	      pos.z *= radius / dist;
	    }
	  }
	*/
	AFRAME.registerComponent('relative-move', {
	  schema: {
	    speed: { default: 0.005 },
	    radius: { default: 1.5 }
	  },
	
	  init() {
	    this.moveVec = { x: 0, z: 0 };
	    this.moving = false;
	
	    window.startMove = (x, z) => {
	      this.moveVec.x = x;
	      this.moveVec.z = z;
	      this.moving = true;
	    };
	
	    window.stopMove = () => {
	      this.moving = false;
	    };
	  },
	
	  tick() {
	    if (!this.moving) return;
	
	    const rig = this.el;
	    const camera = rig.querySelector('a-camera');
	
	    const dir = new THREE.Vector3();
	    camera.object3D.getWorldDirection(dir);
	    dir.y = 0;
	    dir.normalize();
	
	    const right = new THREE.Vector3()
	      .crossVectors(dir, new THREE.Vector3(0, 1, 0))
	      .normalize();
	
	    const pos = rig.object3D.position;
	
	    pos.addScaledVector(dir, -this.moveVec.z * this.data.speed);
	    pos.addScaledVector(right, this.moveVec.x * this.data.speed);
		
	
	    // å††å½¢åˆ¶é™
		const d = Math.sqrt(pos.x * pos.x + pos.z * pos.z);
	    if (d > this.data.radius) {
		  const ratio = this.data.radius / d;
		  pos.x *= ratio;
		  pos.z *= ratio;
		  pos.y = -1.3;
		}
	  }
	});
	
	//***** èª¬æ˜æ–‡è¿½åŠ  *****
	
	const panelTexts = {
	  Panel1: 'èª¬æ˜æ–‡1<br><a href="https://example.com" target="_blank">è©³ç´°</a>',
	  Panel2: 'èª¬æ˜æ–‡2',
	  Panel3: 'èª¬æ˜æ–‡3',
	  Panel4: 'èª¬æ˜æ–‡4',
	  Panel5: 'èª¬æ˜æ–‡5',
	  Panel6: 'èª¬æ˜æ–‡6'
	};
	
	//***** ãƒ•ãƒ¯ãƒ•ãƒ¯ä¸Šä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ *****
	AFRAME.registerComponent('float-y', {
	  schema: {
	    amplitude: { default: 0.05 }, // æºã‚Œå¹…
	    speed: { default: 1 }         // æºã‚Œé€Ÿåº¦
	  },
	
	  init() {
	    this.startY = this.el.object3D.position.y;
	    this.time = 0;
	  },
	
	  tick(time, delta) {
	    this.time += delta / 1000;
	    this.el.object3D.position.y =
	      this.startY +
	      Math.sin(this.time * this.data.speed) * this.data.amplitude;
	  }
	});
	
	AFRAME.registerComponent('panel-interaction', {
	  init() {
	    this.el.addEventListener('click', () => {
	      console.log('Panel Clicked');
	
	      const id = this.el.userData.panelId;
	      if (!id) return;
	
	      document.getElementById('panelText').innerHTML =
	        panelTexts[id];
	      document.getElementById('panelInfo').style.display = 'block';
	    });
	  }
	});
	
	function closeInfo() {
	  document.getElementById('panelInfo').style.display = 'none';
	}
	
</script>

</body>
</html>
